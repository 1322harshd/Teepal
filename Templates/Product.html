<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customize {{ product.Item }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <style>
        body {
            background: #f5f6fa;
            font-family: 'Poppins', Arial, sans-serif;
            margin: 0;
        }
        .customize-main {
            max-width: 1100px;
            margin: 40px auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px #0001;
            padding: 32px 32px 24px 32px;
            display: flex;
            gap: 40px;
            align-items: flex-start;
        }
        .product-preview-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 260px;
        }
        .product-img-card {
            background: #fafafa;
            border-radius: 14px;
            box-shadow: 0 2px 8px #0001;
            padding: 18px;
            margin-bottom: 18px;
            width: 260px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .product-img-card img {
            width: 180px;
            height: 180px;
            object-fit: contain;
            border-radius: 10px;
            background: #fff;
        }
        .product-info {
            text-align: center;
            margin-top: 10px;
        }
        .product-info h2 {
            margin: 0 0 6px 0;
            font-size: 1.25em;
            font-weight: 700;
            color: #222;
        }
        .product-info p {
            margin: 0;
            color: #888;
            font-size: 1em;
        }
        .canvas-section {
            flex: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        .canvas-bg-wrap {
            position: relative;
            width: 400px;
            height: 400px;
        }
        #canvas {
            position: absolute;
            left: 0;
            top: 0;
            z-index: 2;
            background: transparent;
        }
        .canvas-header {
            font-size: 1.2em;
            font-weight: 600;
            color: #3bb77e;
            margin-bottom: 10px;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 10px;
            align-items: center;
            justify-content: center;
        }
        .controls input[type="text"] {
            padding: 7px 12px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 1em;
        }
        .controls button, .controls label {
            background: #3bb77e;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.18s;
        }
        .controls button:hover, .controls label:hover {
            background: #2fa96b;
        }
        .controls input[type="file"] {
            display: none;
        }
        .action-buttons {
            display: flex;
            gap: 16px;
            margin-top: 10px;
            justify-content: center;
        }
        .action-buttons button {
            background: #222;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 8px 20px;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.18s;
        }
        .action-buttons button:hover {
            background: #3bb77e;
        }
        @media (max-width: 900px) {
            .customize-main { flex-direction: column; gap: 24px; padding: 18px 4vw; }
            .product-preview-section, .canvas-section { align-items: center; }
        }
        @media (max-width: 600px) {
            .customize-main { padding: 8px 2vw; }
            .product-img-card { width: 98vw; }
            #canvas { width: 98vw !important; }
        }
    </style>
</head>
<body>
    <div class="customize-main">
        <div class="product-preview-section">
            <div class="product-img-card">
                <img src="{{ url_for('static', filename=product.Image) if product.Image else url_for('static', filename='product-placeholder.png') }}" alt="{{ product.Item }}">
            </div>
            <div class="product-info">
                <h2>{{ product.Item }}</h2>
                <p>Brand: {{ product.Brand }}</p>
                <p style="color:#3bb77e; font-weight:600;">${{ product.Price }}</p>
            </div>
        </div>
        <div class="canvas-section">
            <div class="canvas-header">Design Your Product</div>
            <div class="canvas-bg-wrap" style="position:relative; width:400px; height:400px;">
                <img class="canvas-product-bg"
                     src="{{ url_for('static', filename=product.Image) if product.Image else url_for('static', filename='product-placeholder.png') }}"
                     alt="{{ product.Item }}"
                     style="position:absolute; left:0; top:0; width:400px; height:400px; z-index:1; pointer-events:none; border-radius:10px; object-fit:contain;">
                <canvas id="canvas" width="400" height="400" style="position:absolute; left:0; top:0; z-index:2; background:transparent;"></canvas>
            </div>
            <div class="controls">
                <input type="text" id="textInput" placeholder="Add text">
                <button onclick="addText()">Add Text</button>
                <label for="imageUpload" style="margin-bottom:0;">Upload Image</label>
                <input type="file" id="imageUpload" accept="image/*" onchange="addImage()">
                <button onclick="clearCanvas()" style="background:#e74c3c;">Clear</button>
            </div>
            <div class="action-buttons">
                <form id="saveDesignForm" method="POST" enctype="application/x-www-form-urlencoded" action="{{ url_for('save_design', product_id=product.ProductId) }}">
                    <input type="hidden" name="design_data" id="designDataInput">
                    <button type="button" onclick="saveDesign()">Save Design</button>
                </form>
                <button onclick="closeModal()">Back to Product</button>
            </div>
        </div>
    </div>
    <script>
        // Initialize Fabric.js canvas
        const canvas = new fabric.Canvas('canvas', {
            selection: true,
            preserveObjectStacking: true
        });

        // Make sure the canvas is interactive
        canvas.selection = true;
        canvas.isDrawingMode = false;

        // Add text and make it movable/resizable
        function addText() {
            const value = document.getElementById('textInput').value;
            if (!value) return;
            const text = new fabric.Textbox(value, {
                left: 100, top: 100, fontSize: 24, fill: '#222', fontFamily: 'Poppins'
            });
            text.selectable = true;
            text.evented = true;
            text.hasControls = true;
            text.hasBorders = true;
            canvas.add(text);
            canvas.setActiveObject(text);
            canvas.renderAll();
        }

        // Add image and make it movable/resizable
        function addImage() {
            const file = imageUpload.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    fabric.Image.fromURL(e.target.result, function(img) {
                        img.scaleToWidth(120);
                        img.set({ left: 120, top: 120 });
                        img.selectable = true;
                        img.evented = true;
                        img.hasControls = true;
                        img.hasBorders = true;
                        canvas.add(img);
                        canvas.setActiveObject(img);
                        canvas.renderAll();
                    });
                };
                reader.readAsDataURL(file);
            }
        }

        // Clear canvas
        function clearCanvas() {
            canvas.clear();
            canvas.selection = true;
        }

        // Make sure the imageUpload input is available
        const imageUpload = document.getElementById('imageUpload');
        document.querySelector('label[for="imageUpload"]').onclick = function() { imageUpload.click(); };

        function saveDesign() {
            const dataURL = canvas.toDataURL("image/png");
            document.getElementById('designDataInput').value = dataURL;
            document.getElementById('saveDesignForm').submit();
        }

        function closeModal() {
            window.location.href = "{{ url_for('product', product_id=product.ProductId) }}";
        }

        // Ensure all objects are always selectable and movable
        canvas.on('object:added', function(e) {
            if (e.target) {
                e.target.selectable = true;
                e.target.evented = true;
                e.target.hasControls = true;
                e.target.hasBorders = true;
            }
        });

        canvas.on('selection:cleared', function() {
            canvas.forEachObject(function(obj) {
                obj.selectable = true;
                obj.evented = true;
                obj.hasControls = true;
                obj.hasBorders = true;
            });
        });

        // Load saved design if present
        {% if design_image %}
        fabric.Image.fromURL("{{ url_for('static', filename=design_image) }}", function(img) {
            img.set({ left: 0, top: 0, selectable: false, evented: false });
            canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas), {
                scaleX: canvas.width / img.width,
                scaleY: canvas.height / img.height
            });
        });
        {% endif %}
    </script>
</body>
</html>